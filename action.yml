name: 'auto-build-android'
description: 'Builds and signs the android application'
inputs:
  path-to-control-file:
    description: 'The TSX file that holds the version-string and build number for Android'
    required: true
    default: constants.tsx

  keystore-secret:
    description: 'Secret-variable with the base64 encoded keystore certificate'
    required: true

  keystore-alias:
    description: 'The alias for the keystore certificate'
    required: true

  keystore-password:
    description: 'The password for the keystore certificate'
    required: true

  name-of-version-string:
    description: 'The name of the version-string variable on the TSX file'
    required: true
    default: PUBLIC_VERSION

  name-of-build-string:
    description: 'The name of the build version variable on the TSX file'
    required: true
    default: BUILD_ANDROID

  java-version:
    description: 'Java version to use'
    required: true
    default: '17'

  node-version:
    description: 'Node version to use'
    required: true
    default: 16.x


runs:
  using: "composite"
  steps:
    - name: Setup version string and build number
      id: globals
      shell: bash
      run: cat ${{inputs.path-to-control-file}}
    
    - name: Get version-string information from file
      shell: bash
      run:  echo "VERSION_STRING = $(grep -oP '${{ inputs.name-of-version-string }} = \s*\K\d+' ${{ inputs.path-to-control-file }})" >> $GITHUB_ENV

    - name: Get build information from file
      shell: bash
      run: echo "BUILD_NUMBER = $(grep -oP '${{ inputs.name-of-build-string }} = \s*\K\d+' ${{ inputs.path-to-control-file }})" >> $GITHUB_ENV

    - name: Setup JAVA
      uses: actions/setup-java@v4.0.0
      with:
        distribution: 'adopt'
        java-version: ${{ inputs.java-version }}
      
    - name: Setup Node.js
      uses: actions/setup-node@v3.6.0
      with:
        node-version: ${{inputs.node-version}}

    - name: Unpack Keystore file
      shell: bash
      run: base64 -d << ${{inputs.keystore-secret}} > keyfile.jks

    - name: Setup IONIC
      shell: bash
      run: npm install -g @ionic/cli

    - name: Install app dependencies
      shell: bash
      run: npm install

    - name: Build the app and generate Android files
      shell: bash
      env:
        CI: ""
      run: |
        echo "Building the app ..."
        ionic --max_old_space_size=2048 build
        echo "Generate Android files ..."
        ionic capacitor copy android
        echo "Build android-dev version ..."
        ionic capacitor build android
        echo "Build android-prod version ..."
        ionic capacitor build android --release --prod

    - name: Generate the resources
      shell: bash
      run: npx @capacitor/assets generate --android

    - name: Update versioning on source files
      shell: bash
      run: |
        echo "Change build number ..."
        sed -i "s/versionCode 1/versionCode ${{env.BUILD_NUMBER}}/g" android/app/build.gradle
        echo "Change version number ..."
        sed -i "s/versionName \"1.0\"/versionName \"${{env.VERSION_STRING}}\"/g" android/app/build.gradle 
        echo "Display changes on android/app/build.gradle"
        cat android/app/build.gradle
    

    - name: Sign the release app
      shell: bash
      run: npx cap build android --androidreleasetype=AAB --keystorealias=${{ inputs.keystore-alias }} --keystorealiaspass=${{ inputs.keystore-password }} --keystorepass=${{ inputs.keystore-password }} --keystorepath=${{ github.action_path }}/'keyfile.jks'